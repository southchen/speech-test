<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­ä¾‹å¥éŸ³é¢‘ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ—¥è¯­ä¾‹å¥éŸ³é¢‘ç”Ÿæˆå™¨</h1>
            <p>â€œSentences are the molecules of language; everything else is just atoms.â€</p>
            <p>â€” Fluent Forever, Chapter 5: Sentence Play</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <div class="form-group">
                    <label for="textInput">è¾“å…¥æ—¥è¯­æ–‡æœ¬:</label>
                    <textarea 
                        id="textInput" 
                        placeholder="è¯·è¾“å…¥æ—¥è¯­æ–‡æœ¬ï¼Œä¾‹å¦‚ï¼šç¾å‘³ã—ã‹ã£ãŸï¼ã¾ãŸæ¥ã¾ã™ã€‚"
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="voiceSelect">é€‰æ‹©å£°éŸ³:</label>
                    <select id="voiceSelect">
                        <option value="ja-JP-NanamiNeural">Nanami (å¥³å£°ï¼Œæ¨è)</option>
                        <option value="ja-JP-KeitaNeural">Keita (ç”·å£°)</option>
                        <option value="ja-JP-AoiNeural">Aoi (å¥³å£°ï¼Œå¹´è½»)</option>
                        <option value="ja-JP-DaichiNeural">Daichi (ç”·å£°ï¼Œæˆç†Ÿ)</option>
                    </select>
                </div>

                <div class="controls">
                    <button id="generateBtn" class="btn btn-primary">
                        ğŸµ ç”ŸæˆéŸ³é¢‘
                    </button>
                    <button id="playBtn" class="btn btn-secondary" disabled>
                        â–¶ï¸ æ’­æ”¾
                    </button>
                    <button id="downloadBtn" class="btn btn-download" disabled>
                        ğŸ’¾ ä¸‹è½½MP3
                    </button>
                </div>
            </div>

            <div id="statusDiv"></div>

            <div id="audioSection" class="audio-section" style="display: none;">
                <h3>ç”Ÿæˆçš„éŸ³é¢‘:</h3>
                <audio id="audioPlayer" class="audio-player" controls></audio>
            </div>

            <div class="examples">
                <h3>ç¤ºä¾‹å¥å­ (ç‚¹å‡»ä½¿ç”¨):</h3>
                <div class="example-list">
                    <div class="example-item">ç¾å‘³ã—ã‹ã£ãŸï¼ã¾ãŸæ¥ã¾ã™ã€‚</div>
                    <div class="example-item">æ˜æ—¥ã¯é›¨ã ã¨æ€ã„ã¾ã™ã€‚</div>
                    <div class="example-item">ç§ã¯çŒ«ãŒå¥½ãã§ã™ã€‚</div>
                    <div class="example-item">ã“ã“ã¯é™ã‹ã§ã„ã„ã§ã™ã­ã€‚</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class JapaneseTTS {
            constructor() {
                this.audioBlob = null;
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.textInput = document.getElementById('textInput');
                this.voiceSelect = document.getElementById('voiceSelect');
                this.generateBtn = document.getElementById('generateBtn');
                this.playBtn = document.getElementById('playBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.statusDiv = document.getElementById('statusDiv');
                this.audioSection = document.getElementById('audioSection');
                this.audioPlayer = document.getElementById('audioPlayer');
            }

            bindEvents() {
                this.generateBtn.addEventListener('click', () => this.generateAudio());
                this.playBtn.addEventListener('click', () => this.playAudio());
                this.downloadBtn.addEventListener('click', () => this.downloadAudio());

                // ç¤ºä¾‹å¥å­ç‚¹å‡»äº‹ä»¶
                document.querySelectorAll('.example-item').forEach(item => {
                    item.addEventListener('click', () => {
                        this.textInput.value = item.textContent;
                    });
                });

                // å›è½¦å¿«æ·é”®
                this.textInput.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        this.generateAudio();
                    }
                });
            }

            createSSML(text, voice) {
                return `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="ja-JP">
                    <voice name="${voice}">
                        <prosody rate="medium" pitch="medium">${text}</prosody>
                    </voice>
                </speak>`;
            }

            showStatus(message, type = 'loading') {
                this.statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            }

            hideStatus() {
                this.statusDiv.innerHTML = '';
            }

            generateRequestId() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            generateTimestamp() {
                return new Date().toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            }

            async generateAudio() {
                const text = this.textInput.value.trim();
                if (!text) {
                    this.showStatus('è¯·è¾“å…¥è¦è½¬æ¢çš„æ—¥è¯­æ–‡æœ¬', 'error');
                    return;
                }

                const voice = this.voiceSelect.value;
                
                this.generateBtn.disabled = true;
                this.showStatus('<span class="loader"></span> æ­£åœ¨ç”ŸæˆéŸ³é¢‘ï¼Œè¯·ç¨å€™...', 'loading');

                try {
                    await this.synthesizeSpeechWebSocket(text, voice);
                } catch (error) {
                    console.error('ç”ŸæˆéŸ³é¢‘å¤±è´¥:', error);
                    this.showStatus(`âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
                } finally {
                    this.generateBtn.disabled = false;
                }
            }

            async synthesizeSpeechWebSocket(text, voice) {
                return new Promise((resolve, reject) => {
                    const requestId = this.generateRequestId();
                    const timestamp = this.generateTimestamp();
                    
                    // WebSocketè¿æ¥URL
                    const wsUrl = `wss://speech.platform.bing.com/consumer/speech/synthesize/readaloud/edge/v1?TrustedClientToken=6A5AA1D4EAFF4E9FB37E23D68491D6F4&ConnectionId=${requestId}`;
                    
                    const ws = new WebSocket(wsUrl);
                    const audioChunks = [];
                    let hasError = false;

                    ws.onopen = () => {
                        console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                        
                        // å‘é€é…ç½®æ¶ˆæ¯
                        const configMessage = `X-Timestamp:${timestamp}\r\nContent-Type:application/json; charset=utf-8\r\nPath:speech.config\r\n\r\n{"context":{"synthesis":{"audio":{"metadataoptions":{"sentenceBoundaryEnabled":"false","wordBoundaryEnabled":"true"},"outputFormat":"audio-24khz-48kbitrate-mono-mp3"}}}}`;
                        ws.send(configMessage);

                        // å‘é€SSMLæ¶ˆæ¯
                        const ssml = this.createSSML(text, voice);
                        const ssmlMessage = `X-RequestId:${requestId}\r\nX-Timestamp:${timestamp}\r\nContent-Type:application/ssml+xml\r\nPath:ssml\r\n\r\n${ssml}`;
                        ws.send(ssmlMessage);
                    };

                    ws.onmessage = async (event) => {
                        if (typeof event.data === 'string') {
                            console.log('æ”¶åˆ°æ–‡æœ¬æ¶ˆæ¯:', event.data);
                            
                            if (event.data.includes('Path:turn.end')) {
                                // éŸ³é¢‘ä¼ è¾“å®Œæˆ
                                console.log('éŸ³é¢‘ä¼ è¾“å®Œæˆï¼Œæ”¶åˆ°çš„éŸ³é¢‘å—æ•°é‡:', audioChunks.length);
                                ws.close();
                                
                                if (audioChunks.length > 0) {
                                    this.processAudioChunks(audioChunks);
                                    resolve();
                                } else {
                                    reject(new Error('æœªæ”¶åˆ°éŸ³é¢‘æ•°æ®'));
                                }
                            }
                        } else if (event.data instanceof Blob) {
                            // å¤„ç†Blobç±»å‹çš„äºŒè¿›åˆ¶æ•°æ®
                            const arrayBuffer = await event.data.arrayBuffer();
                            this.parseAudioMessage(arrayBuffer, audioChunks);
                        } else if (event.data instanceof ArrayBuffer) {
                            // ç›´æ¥å¤„ç†ArrayBuffer
                            this.parseAudioMessage(event.data, audioChunks);
                        } else {
                            console.log('æ”¶åˆ°æœªçŸ¥ç±»å‹æ•°æ®:', typeof event.data);
                        }
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocketé”™è¯¯:', error);
                        hasError = true;
                        reject(new Error('WebSocketè¿æ¥é”™è¯¯'));
                    };

                    ws.onclose = (event) => {
                        console.log('WebSocketè¿æ¥å·²å…³é—­:', event.code, event.reason);
                        if (!hasError && audioChunks.length === 0) {
                            reject(new Error('è¿æ¥æ„å¤–å…³é—­ï¼Œæœªæ”¶åˆ°éŸ³é¢‘æ•°æ®'));
                        }
                    };

                    // è®¾ç½®è¶…æ—¶
                    setTimeout(() => {
                        if (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN) {
                            ws.close();
                            reject(new Error('è¯·æ±‚è¶…æ—¶'));
                        }
                    }, 30000);
                });
            }

            parseAudioMessage(arrayBuffer, audioChunks) {
                try {
                    console.log('è§£æéŸ³é¢‘æ¶ˆæ¯ï¼Œæ€»å¤§å°:', arrayBuffer.byteLength);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ•°æ®è¯»å–å¤´éƒ¨
                    if (arrayBuffer.byteLength < 2) {
                        console.log('æ•°æ®å¤ªå°ï¼Œè·³è¿‡');
                        return;
                    }
                    
                    const dataView = new DataView(arrayBuffer);
                    
                    // è¯»å–å¤´éƒ¨é•¿åº¦ (big-endian)
                    const headerLength = dataView.getUint16(0, false);
                    console.log('å¤´éƒ¨é•¿åº¦:', headerLength);
                    
                    // éªŒè¯å¤´éƒ¨é•¿åº¦æ˜¯å¦åˆç†
                    if (headerLength >= arrayBuffer.byteLength) {
                        console.log('å¤´éƒ¨é•¿åº¦å¼‚å¸¸ï¼Œå°è¯•è¯»å–æ•´ä¸ªæ¶ˆæ¯ä½œä¸ºéŸ³é¢‘æ•°æ®');
                        // æœ‰äº›æ¶ˆæ¯å¯èƒ½æ²¡æœ‰æ ‡å‡†å¤´éƒ¨ï¼Œç›´æ¥å½“ä½œéŸ³é¢‘æ•°æ®
                        if (arrayBuffer.byteLength > 100) { // åªæœ‰å½“æ•°æ®è¶³å¤Ÿå¤§æ—¶æ‰å½“ä½œéŸ³é¢‘
                            audioChunks.push(arrayBuffer);
                            console.log('æ·»åŠ æ•´ä¸ªæ¶ˆæ¯ä½œä¸ºéŸ³é¢‘å—ï¼Œå¤§å°:', arrayBuffer.byteLength);
                        }
                        return;
                    }
                    
                    // è¯»å–å¤´éƒ¨å†…å®¹
                    const headerBytes = new Uint8Array(arrayBuffer, 2, headerLength);
                    const headerText = new TextDecoder('utf-8').decode(headerBytes);
                    console.log('å¤´éƒ¨å†…å®¹:', headerText);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯éŸ³é¢‘æ•°æ®
                    if (headerText.includes('Path:audio') || headerText.includes('Content-Type:audio')) {
                        const audioDataStart = 2 + headerLength;
                        if (audioDataStart < arrayBuffer.byteLength) {
                            const audioData = arrayBuffer.slice(audioDataStart);
                            audioChunks.push(audioData);
                            console.log('æå–éŸ³é¢‘æ•°æ®ï¼Œå¤§å°:', audioData.byteLength);
                        }
                    } else {
                        console.log('ééŸ³é¢‘æ¶ˆæ¯ï¼Œè·³è¿‡');
                    }
                } catch (error) {
                    console.error('è§£æéŸ³é¢‘æ¶ˆæ¯å‡ºé”™:', error);
                    // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•å°†æ•´ä¸ªæ•°æ®å½“ä½œéŸ³é¢‘ï¼ˆå®¹é”™å¤„ç†ï¼‰
                    if (arrayBuffer.byteLength > 1000) { // åªæœ‰è¶³å¤Ÿå¤§çš„æ•°æ®æ‰å¯èƒ½æ˜¯éŸ³é¢‘
                        audioChunks.push(arrayBuffer);
                        console.log('è§£æå¤±è´¥ï¼Œå°†æ•´ä¸ªæ¶ˆæ¯å½“ä½œéŸ³é¢‘å—');
                    }
                }
            }

            processAudioChunks(audioChunks) {
                console.log('å¼€å§‹å¤„ç†éŸ³é¢‘å—ï¼Œæ€»æ•°:', audioChunks.length);
                
                // åˆå¹¶æ‰€æœ‰éŸ³é¢‘å—
                const totalLength = audioChunks.reduce((sum, chunk) => sum + chunk.byteLength, 0);
                console.log('éŸ³é¢‘æ€»å¤§å°:', totalLength, 'bytes');
                
                if (totalLength === 0) {
                    this.showStatus('âŒ æœªæ”¶åˆ°æœ‰æ•ˆéŸ³é¢‘æ•°æ®', 'error');
                    return;
                }
                
                const combinedArray = new Uint8Array(totalLength);
                
                let offset = 0;
                for (const chunk of audioChunks) {
                    const chunkArray = new Uint8Array(chunk);
                    combinedArray.set(chunkArray, offset);
                    offset += chunk.byteLength;
                    console.log('åˆå¹¶éŸ³é¢‘å—ï¼Œåç§»:', offset);
                }

                // éªŒè¯MP3å¤´éƒ¨ï¼ˆMP3æ–‡ä»¶åº”è¯¥ä»¥0xFF 0xFBæˆ–ç±»ä¼¼å¼€å¤´ï¼‰
                if (combinedArray.length > 4) {
                    const header = Array.from(combinedArray.slice(0, 4))
                        .map(b => '0x' + b.toString(16).padStart(2, '0'))
                        .join(' ');
                    console.log('éŸ³é¢‘æ–‡ä»¶å¤´éƒ¨:', header);
                }

                // åˆ›å»ºéŸ³é¢‘Blob
                this.audioBlob = new Blob([combinedArray], { type: 'audio/mpeg' });
                
                // åˆ›å»ºéŸ³é¢‘URLå¹¶æ’­æ”¾
                const audioUrl = URL.createObjectURL(this.audioBlob);
                this.audioPlayer.src = audioUrl;
                
                // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
                this.audioSection.style.display = 'block';
                
                // å¯ç”¨æŒ‰é’®
                this.playBtn.disabled = false;
                this.downloadBtn.disabled = false;
                
                this.showStatus('âœ… éŸ³é¢‘ç”ŸæˆæˆåŠŸï¼', 'success');
                
                // 3ç§’åéšè—çŠ¶æ€
                setTimeout(() => this.hideStatus(), 3000);

                console.log('éŸ³é¢‘å¤„ç†å®Œæˆï¼Œå¯æ’­æ”¾å¤§å°:', this.audioBlob.size, 'bytes');
            }

            playAudio() {
                if (this.audioPlayer.src) {
                    this.audioPlayer.play();
                }
            }

            downloadAudio() {
                if (!this.audioBlob) return;

                const text = this.textInput.value.trim();
                const cleanText = text.replace(/[^\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\u3400-\u4DBF]/g, '').substring(0, 20);
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = `japanese_tts_${cleanText || timestamp}.mp3`;

                const url = URL.createObjectURL(this.audioBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showStatus(`ğŸ“ å·²ä¸‹è½½: ${filename}`, 'success');
                setTimeout(() => this.hideStatus(), 3000);
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new JapaneseTTS();
        });
    </script>
</body>
</html>